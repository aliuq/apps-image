{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Apps Image Meta Schema",
  "description": "Docker 镜像应用的元数据配置规范",
  "type": "object",
  "required": ["name", "type", "variants"],
  "additionalProperties": false,
  "properties": {
    "name": {
      "type": "string",
      "description": "应用名称，用作默认的镜像名称",
      "pattern": "^[a-z0-9][a-z0-9_-]*[a-z0-9]$"
    },
    "type": {
      "type": "string",
      "enum": ["app", "base", "sync"],
      "description": "镜像类型"
    },
    "title": {
      "type": "string",
      "description": "应用显示名称"
    },
    "description": {
      "type": "string",
      "description": "应用描述"
    },
    "license": {
      "type": "string",
      "description": "许可证"
    },
    "context": {
      "type": "string",
      "description": "构建上下文路径，相对于仓库根目录",
      "default": "apps/{name}"
    },
    "readme": {
      "oneOf": [
        { "type": "string" },
        { "type": "boolean" }
      ],
      "description": "README 文件路径或是否包含 README",
      "default": "README.md"
    },
    "variants": {
      "type": "object",
      "description": "镜像变体配置，支持一个应用多个镜像",
      "patternProperties": {
        "^[a-zA-Z0-9_-]+$": {
          "$ref": "#/definitions/ImageVariant"
        }
      },
      "minProperties": 1
    },
    "skip": {
      "type": "boolean",
      "description": "是否跳过此应用的处理",
      "default": false
    }
  },
  "definitions": {
    "ImageVariant": {
      "type": "object",
      "required": ["checkver"],
      "properties": {
        "version": {
          "type": "string",
          "description": "当前版本"
        },
        "sha": {
          "type": "string",
          "description": "当前提交 SHA",
          "pattern": "^[a-f0-9]{7,40}$"
        },
        "enabled": {
          "type": "boolean",
          "description": "是否启用此变体",
          "default": true
        },
        "checkver": {
          "$ref": "#/definitions/VersionCheck"
        },
        "docker": {
          "$ref": "#/definitions/DockerConfig"
        }
      }
    },
    "VersionCheck": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["version", "sha", "tag", "manual", "registry"],
          "description": "版本检查类型"
        },
        "repo": {
          "type": "string",
          "description": "上游仓库地址，支持完整 URI (https://github.com/owner/repo) 或简写 (owner/repo)",
          "pattern": "^(https://[^/]+/[^/]+/[^/]+|[^/]+/[^/]+)$"
        },
        "branch": {
          "type": "string",
          "description": "检查的分支",
          "default": "main"
        },
        "file": {
          "type": "string",
          "description": "版本文件路径（用于 version 类型）"
        },
        "regex": {
          "type": "string",
          "description": "版本匹配正则表达式"
        },
        "tagPattern": {
          "type": "string",
          "description": "标签匹配模式（用于 tag 类型）"
        },
        "targetVersion": {
          "type": "string",
          "description": "目标版本（用于手动指定）"
        },
        "processFiles": {
          "type": "array",
          "items": { "type": "string" },
          "description": "需要处理占位符的文件列表",
          "default": ["Dockerfile"]
        },
        "checkFrequency": {
          "type": "string",
          "enum": ["always", "daily", "weekly", "manual"],
          "description": "检查频率",
          "default": "always"
        },
        "lastCheck": {
          "type": "string",
          "description": "上次检查时间（ISO 8601 格式）",
          "format": "date-time"
        }
      },
      "allOf": [
        {
          "if": { "properties": { "type": { "const": "version" } } },
          "then": { "required": ["repo", "file"] }
        },
        {
          "if": { "properties": { "type": { "const": "sha" } } },
          "then": { "required": ["repo"] }
        },
        {
          "if": { "properties": { "type": { "const": "tag" } } },
          "then": { "required": ["repo"] }
        }
      ]
    },
    "DockerConfig": {
      "type": "object",
      "properties": {
        "file": {
          "type": "string",
          "description": "Dockerfile 路径",
          "default": "Dockerfile"
        },
        "images": {
          "type": "array",
          "items": { "type": "string" },
          "description": "镜像名称列表",
          "default": ["aliuq/{name}", "ghcr.io/aliuq/{name}"],
          "minItems": 1
        },
        "tags": {
          "type": "array",
          "items": { "type": "string" },
          "description": "标签模板列表",
          "default": [
            "type=raw,value=latest",
            "type=raw,value={{version}}",
            "type=raw,value={{sha}}"
          ],
          "minItems": 1
        },
        "platforms": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["linux/amd64", "linux/arm64", "linux/arm/v7", "linux/arm/v6", "linux/386", "linux/ppc64le", "linux/s390x"]
          },
          "description": "支持的平台",
          "default": ["linux/amd64", "linux/arm64"],
          "minItems": 1
        },
        "labels": {
          "type": "object",
          "description": "Docker 标签",
          "additionalProperties": { "type": "string" }
        },
        "buildArgs": {
          "type": "object",
          "description": "构建参数",
          "additionalProperties": { "type": "string" }
        },
        "secrets": {
          "type": "array",
          "items": { "type": "string" },
          "description": "构建密钥"
        },
        "outputs": {
          "type": "array",
          "items": { "type": "string" },
          "description": "输出配置"
        },
        "cache": {
          "$ref": "#/definitions/CacheConfig"
        },
        "push": {
          "type": "boolean",
          "description": "是否推送镜像",
          "default": true
        },
        "load": {
          "type": "boolean",
          "description": "是否加载镜像到本地",
          "default": false
        }
      }
    },
    "CacheConfig": {
      "type": "object",
      "properties": {
        "from": {
          "type": "array",
          "items": { "type": "string" },
          "description": "缓存来源"
        },
        "to": {
          "type": "array",
          "items": { "type": "string" },
          "description": "缓存目标"
        }
      }
    }
  }
}
