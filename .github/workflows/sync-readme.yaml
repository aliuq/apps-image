name: Update README

on:
  push:
    branches:
      - master
    paths:
      - apps/*/README.md

jobs:
  sync-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整历史记录

      - name: Prepare
        id: prepare
        uses: aliuq/script-action@v1
        with:
          auto_install: true
          script: |
            async function execCommand1(command: string, args?: string[], options?: exec.ExecOptions): Promise<string> {
              let result = ''
              let error = ''
              try {
                await exec.exec(command, args, {
                  listeners: {
                    stdout: (data: Buffer) => {
                      result += data.toString()
                    },
                    stderr: (data) => {
                      error += data.toString()
                    },
                  },
                  silent: true,
                  ...options,
                })
                return result?.trim?.()
              }
              catch (e: any) {
                if (error)
                  core.warning(error)
                core.warning(e.message)
                return ''
              }
            }

            // 获取最近一次提交的文件
            const changedFiles = await execCommand1('git diff-tree --no-commit-id --name-only -r HEAD')
            console.log('changedFiles:', changedFiles)

      # - name: Sync README
      #   uses: peter-evans/dockerhub-description@v4
      #   with:
      #     username: ${{ secrets.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}
      #     repository: ${{ steps.prep.outputs.repo }}
      #     readme-filepath: ${{ steps.prep.outputs.readme_path }}
