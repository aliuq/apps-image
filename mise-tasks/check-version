#!/usr/bin/env bun
//MISE description="Run check-version workflow via act"

/**
 * check-version 任务
 *
 * 通过交互式提示收集参数，然后使用 act 执行 .github/workflows/check-version.yaml
 *
 * 功能：
 * - 支持搜索选择上下文（autocompleteMultiselect）
 * - 支持从历史记录中复用之前执行过的命令
 * - 可选保存执行日志到 .mise-logs/ 目录
 */

import { intro, outro, log, select, autocompleteMultiselect } from '@clack/prompts'
import {
  assertNotCancel,
  confirmAndRun,
  ensureActAvailable,
  getContextOptions,
  promptHistory,
  promptSaveLog,
} from './lib/utils.mjs'

const TASK_NAME = 'check-version'
const WORKFLOW = '.github/workflows/check-version.yaml'

async function main() {
  intro(TASK_NAME)
  ensureActAvailable()

  // ── 1. 尝试复用历史命令 ───────────────────────────────────────────────
  const historyArgs = await promptHistory(TASK_NAME)
  if (historyArgs) {
    const saveLog = await promptSaveLog()
    // 从历史参数中提取 context 用于日志文件名
    const ctxArg = historyArgs.find((a, i) => i > 0 && historyArgs[i - 1] === '--input' && a.startsWith('context='))
    const context = ctxArg ? ctxArg.replace('context=', '') : 'unknown'

    await confirmAndRun({
      task: TASK_NAME,
      args: historyArgs,
      label: `[history] context=${context}`,
      context,
      saveLog,
    })
    outro('Done!')
    return
  }

  // ── 2. 全新配置流程 ───────────────────────────────────────────────────

  // 2a. 选择检查范围
  const mode = assertNotCancel(await select({
    message: 'Select check scope',
    options: [
      { value: 'all', label: 'All contexts', hint: 'Check all contexts' },
      { value: 'specific', label: 'Specific contexts', hint: 'Search and select' },
    ],
  }))

  let contextValue = 'all'
  if (mode === 'specific') {
    const options = getContextOptions()
    if (options.length === 0) {
      log.error('No context directories found (apps/, base/, test/)')
      process.exit(1)
    }

    // 使用 autocompleteMultiselect 支持搜索，解决大量选项时的高度溢出问题
    const contexts = assertNotCancel(await autocompleteMultiselect({
      message: 'Search and select contexts',
      options,
      placeholder: 'Type to search...',
      maxItems: 15,
    }))

    if (contexts.length === 0) {
      log.warn('No contexts selected, falling back to all')
      contextValue = 'all'
    }
    else {
      contextValue = contexts.join(',')
    }
  }

  // 2b. 是否创建 PR
  const createPr = assertNotCancel(await select({
    message: 'Create PR?',
    options: [
      { value: 'false', label: 'No', hint: 'Do not create PR, just check' },
      { value: 'true', label: 'Yes', hint: 'Create PR, and trigger build-image workflow' },
      { value: 'development', label: 'Development', hint: 'Create PR, but skip build-image workflow' },
    ],
  }))

  // 2c. Debug 模式
  const debug = assertNotCancel(await select({
    message: 'Enable debug mode?',
    options: [
      { value: 'false', label: 'No' },
      { value: 'true', label: 'Yes' },
    ],
  }))

  // 2d. 日志保存
  const saveLog = await promptSaveLog()

  // ── 3. 构建 act 参数 ──────────────────────────────────────────────────
  const args = ['workflow_dispatch', '-W', WORKFLOW]
  args.push('--input', `context=${contextValue}`)
  args.push('--input', `create_pr=${createPr}`)
  args.push('--input', `debug=${debug}`)

  // 可读摘要，用于历史记录展示
  const label = `context=${contextValue} create_pr=${createPr} debug=${debug}`

  // ── 4. 确认并执行 ─────────────────────────────────────────────────────
  await confirmAndRun({
    task: TASK_NAME,
    args,
    label,
    context: contextValue,
    saveLog,
  })

  outro('Done!')
}

main().catch((err) => {
  log.error(err.message)
  process.exit(1)
})
